ARG PYTHON_VERSION=3.12
FROM python:${PYTHON_VERSION}-bullseye

WORKDIR /app

RUN apt-get update && apt-get install -y \
    gcc \
    libpq-dev \
    postgresql-client \
    netcat-openbsd \
    openssl \
 && rm -rf /var/lib/apt/lists/*

ENV PIP_CACHE_DIR=/root/.cache/pip
ENV PIP_PROGRESS_BAR=off

# ---- runtime deps first (cache-friendly) ----
COPY requirements.runtime.txt .
RUN --mount=type=cache,target=/root/.cache/pip \
    pip install --no-cache-dir -r requirements.runtime.txt

# ---- then test deps (fast) ----
COPY requirements.dev.txt .
COPY tests/requirements.test.auth.txt tests/requirements.test.auth.txt
RUN --mount=type=cache,target=/root/.cache/pip \
    pip install --no-cache-dir -r tests/requirements.test.auth.txt

# ---- copy application source ----
COPY . .

WORKDIR /app
ENTRYPOINT ["/app/tests/entrypoint.test.auth.sh"]
